version: 0.1
component: build
shell: bash

steps:
  - type: Command
    name: "Upsert single BIP object (download→update|upload)"
    timeoutInSeconds: 900
    command: |
      set -euo pipefail

      : "${BIP_HOST:?Missing BIP_HOST}"                 # https://<pod>.fa.<region>.oraclecloud.com
      : "${BIP_USER:?Missing BIP_USER}"
      : "${BIP_PASS:?Missing BIP_PASS}"
      : "${BIP_REPO_ROOT:?Missing BIP_REPO_ROOT}"       # ej: SAAS/BIP
      : "${BIP_OBJ_NAME:?Missing BIP_OBJ_NAME}"         # ej: testingPipelineDM
      : "${BIP_OBJ_PATH:?Missing BIP_OBJ_PATH}"         # ej: /Custom/KSY/DataModels/testingPipelineDM.xdm  (CON extensión para update)

      echo ">> Searching '${BIP_OBJ_NAME}' in ${BIP_REPO_ROOT} (.xdm/.xdmz/.xdo/.xdoz)"
      SRC="$(find "$BIP_REPO_ROOT" -type f \( -iname "${BIP_OBJ_NAME}.xdm" -o -iname "${BIP_OBJ_NAME}.xdmz" -o -iname "${BIP_OBJ_NAME}.xdo" -o -iname "${BIP_OBJ_NAME}.xdoz" \) | head -n1)"
      [ -n "$SRC" ] || { echo "❌ Source not found"; exit 1; }
      echo ">> Source: $SRC"

      lower="${SRC,,}"
      if [[ "$lower" == *.xdm || "$lower" == *.xdmz ]]; then
        TYPE_RAW="xdm"   # para updateObject
      else
        TYPE_RAW="xdo"
      fi

      # Normaliza a crudo (.xdm/.xdo) para updateObject
      normalize_to_raw() {
        local src="$1"
        case "${src,,}" in
          *.xdmz)
            local tmpdir; tmpdir="$(mktemp -d)"
            cp "$src" "$tmpdir/obj.zip"
            unzip -qo "$tmpdir/obj.zip" -d "$tmpdir"
            local raw; raw="$(find "$tmpdir" -maxdepth 1 -type f -iname '*.xdm' | head -n1)"
            [ -n "$raw" ] || { echo "❌ .xdm not found inside xdmz"; return 1; }
            echo "$raw"
            ;;
          *.xdoz)
            local tmpdir; tmpdir="$(mktemp -d)"
            cp "$src" "$tmpdir/obj.zip"
            unzip -qo "$tmpdir/obj.zip" -d "$tmpdir"
            local raw; raw="$(find "$tmpdir" -maxdepth 1 -type f -iname '*.xdo' | head -n1)"
            [ -n "$raw" ] || { echo "❌ .xdo not found inside xdoz"; return 1; }
            echo "$raw"
            ;;
          *)
            echo "$src"
            ;;
        esac
      }

      RAW_FILE="$(normalize_to_raw "$SRC")" || { echo "❌ Normalization to RAW failed"; exit 1; }
      echo ">> RAW for update: $RAW_FILE"

      RAW_B64="$(base64 -w0 "$RAW_FILE" 2>/dev/null || base64 "$RAW_FILE" | tr -d '\n')"

      # 1) Verificar existencia (downloadObject) usando path CON extensión
      echo ">> Checking existence (downloadObject) at: ${BIP_OBJ_PATH}"
      REQ_DL="$(mktemp)"
      printf '%s\n' \
        '<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:v2="http://xmlns.oracle.com/oxp/service/v2">' \
        '  <soapenv:Body>' \
        '    <v2:downloadObject>' \
        "      <v2:reportAbsolutePath>${BIP_OBJ_PATH}</v2:reportAbsolutePath>" \
        "      <v2:userID>${BIP_USER}</v2:userID>" \
        "      <v2:password>${BIP_PASS}</v2:password>" \
        '    </v2:downloadObject>' \
        '  </soapenv:Body>' \
        '</soapenv:Envelope>' > "$REQ_DL"

      RESP_DL="$(mktemp)"
      HTTP_CODE=$(curl -s -S -u "${BIP_USER}:${BIP_PASS}" \
        -H "Content-Type: text/xml;charset=UTF-8" -H 'SOAPAction: ""' \
        --data @"$REQ_DL" "$BIP_HOST/xmlpserver/services/v2/CatalogService" \
        -w "%{http_code}" -o "$RESP_DL" || true)

      if [[ "$HTTP_CODE" == "200" ]] && ! grep -q "<soapenv:Fault" "$RESP_DL"; then
        EXISTS=1
        echo ">> Object exists → updateObject"
      else
        EXISTS=0
        echo ">> Object NOT found → uploadObject"
      fi

      if [[ "$EXISTS" -eq 1 ]]; then
        # ===== updateObject (requiere .xdm/.xdo crudo y path CON extensión) =====
        REQ_UPD="$(mktemp)"
        printf '%s\n' \
          '<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:v2="http://xmlns.oracle.com/oxp/service/v2">' \
          '  <soapenv:Body>' \
          '    <v2:updateObject>' \
          "      <v2:objectAbsolutePath>${BIP_OBJ_PATH}</v2:objectAbsolutePath>" \
          "      <v2:objectData>${RAW_B64}</v2:objectData>" \
          "      <v2:userID>${BIP_USER}</v2:userID>" \
          "      <v2:password>${BIP_PASS}</v2:password>" \
          '    </v2:updateObject>' \
          '  </soapenv:Body>' \
          '</soapenv:Envelope>' > "$REQ_UPD"

        curl -f -s -S -u "${BIP_USER}:${BIP_PASS}" \
          -H "Content-Type: text/xml;charset=UTF-8" -H 'SOAPAction: ""' \
          --data @"$REQ_UPD" "$BIP_HOST/xmlpserver/services/v2/CatalogService" >/dev/null

        echo "✅ updateObject OK: ${BIP_OBJ_PATH}"
      else
        # ===== uploadObject (requiere .xdmz/.xdoz, path SIN extensión, type xdmz/xdoz) =====
        case "${SRC,,}" in
          *.xdmz) OBJ_TYPE="xdmz" ;;
          *.xdoz) OBJ_TYPE="xdoz" ;;
          *)
            echo "❌ Cannot create new object from raw ${TYPE_RAW}. Provide a .${TYPE_RAW}z (xdmz/xdoz) to use uploadObject."
            exit 1
            ;;
        esac

        UPLOAD_PATH="${BIP_OBJ_PATH%.*}"  # quitar extensión para upload
        ZIP_B64="$(base64 -w0 "$SRC" 2>/dev/null || base64 "$SRC" | tr -d '\n')"

        REQ_UPL="$(mktemp)"
        printf '%s\n' \
          '<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:v2="http://xmlns.oracle.com/oxp/service/v2">' \
          '  <soapenv:Body>' \
          '    <v2:uploadObject>' \
          "      <v2:reportObjectAbsolutePathURL>${UPLOAD_PATH}</v2:reportObjectAbsolutePathURL>" \
          "      <v2:objectType>${OBJ_TYPE}</v2:objectType>" \
          "      <v2:objectZippedData>${ZIP_B64}</v2:objectZippedData>" \
          "      <v2:userID>${BIP_USER}</v2:userID>" \
          "      <v2:password>${BIP_PASS}</v2:password>" \
          '    </v2:uploadObject>' \
          '  </soapenv:Body>' \
          '</soapenv:Envelope>' > "$REQ_UPL"

        curl -f -s -S -u "${BIP_USER}:${BIP_PASS}" \
          -H "Content-Type: text/xml;charset=UTF-8" -H 'SOAPAction: ""' \
          --data @"$REQ_UPL" "$BIP_HOST/xmlpserver/services/v2/CatalogService" >/dev/null

        echo "🆕 uploadObject OK: ${UPLOAD_PATH} (type=${OBJ_TYPE})"
      fi

      echo "✅ Upsert completed"
