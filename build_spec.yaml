version: 0.1
component: build
shell: bash

steps:
  - type: Command
    name: "Import & Activate OIC Integration"
    timeoutInSeconds: 1800
    command: |
      set -euo pipefail

      # Lee directamente los Parameters del pipeline
      : "${OIC_HOST:?Falta OIC_HOST (Parameter)}"
      : "${OIC_USER:?Falta OIC_USER (Parameter)}"
      : "${OIC_PASS:?Falta OIC_PASS (Parameter)}"
      : "${INT_CODE:?Falta INT_CODE (Parameter)}"
      : "${INT_VERSION:?Falta INT_VERSION (Parameter)}"

      AUTH_MODE="${AUTH_MODE:-basic}"

      echo ">> OIC_HOST=$OIC_HOST"
      echo ">> INT_CODE=$INT_CODE"
      echo ">> INT_VERSION=$INT_VERSION"

      INT_ID="${INT_CODE}%7C${INT_VERSION}"

      # Ruta esperada en RAÍZ (tu caso)
      IAR_FILE="./${INT_CODE}_${INT_VERSION}.iar"

      echo ">> Listando raíz del repo:"
      ls -la || true
      echo ">> Listando carpeta build/ (si existe):"
      ls -la build || true

      # Si no está en raíz con el nombre esperado, intenta autodetectar
      if [ ! -f "$IAR_FILE" ]; then
        if [ -f "./$(ls -1 *.iar 2>/dev/null | head -n1)" ]; then
          IAR_FILE="$(ls -1 *.iar | head -n1)"
          echo ">> Usando IAR detectado en raíz: $IAR_FILE"
        elif [ -f "build/$(ls -1 build/*.iar 2>/dev/null | head -n1)" ]; then
          IAR_FILE="$(ls -1 build/*.iar | head -n1)"
          echo ">> Usando IAR detectado en build/: $IAR_FILE"
        else
          echo "❌ No se encontró archivo .iar. Pon ${INT_CODE}_${INT_VERSION}.iar en raíz o en build/."
          exit 1
        fi
      fi
      echo ">> IAR final: $IAR_FILE"

      echo "== Importing IAR (POST) =="
      curl -f -s -S -u "$OIC_USER:$OIC_PASS" \
        -X POST "$OIC_HOST/ic/api/integration/v1/integrations/archive?integrationInstance=${OIC_INSTANCE_ID}" \
        -H "Accept: application/json" \
        -F "file=@${IAR_FILE}"
        -F type=application/octet-stream
      echo "✔ Import completado"

      echo "== Activate Integration =="
      curl -f -s -S -u "$OIC_USER:$OIC_PASS" \
        -X POST "$OIC_HOST/ic/api/integration/v1/integrations/${INT_ID}/actions/activate?integrationInstance=${OIC_INSTANCE_ID}" \
        -H "Accept: application/json"
      echo "✅ Activación OK: ${INT_CODE} ${INT_VERSION}"

